name: Build WinGo USB Package

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Instalar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller pillow

      - name: Compilar SoftPack.exe (onefile portable)
        working-directory: SoftPack
        shell: cmd
        run: >
          pyinstaller
          --name=SoftPack
          --onefile
          --windowed
          --clean
          --noconfirm
          --add-data "icons;icons"
          --hidden-import=config
          --hidden-import=software_manager
          --hidden-import=utils
          --hidden-import=PIL
          --hidden-import=PIL.Image
          --hidden-import=PIL.ImageTk
          --hidden-import=PIL.ImageFont
          --hidden-import=glob
          --hidden-import=ssl
          --hidden-import=webbrowser
          main.py

      - name: Verificar que se creó el .exe
        working-directory: SoftPack
        shell: pwsh
        run: |
          if (Test-Path "dist\SoftPack.exe") {
            Write-Host "SoftPack.exe creado correctamente"
            Get-Item "dist\SoftPack.exe" | Select-Object Name, Length
          } else {
            Write-Host "ERROR: SoftPack.exe no se creo"
            exit 1
          }

      - name: Crear lanzador portable (run_softpack.bat)
        working-directory: SoftPack/dist
        shell: pwsh
        run: |
          $bat = @"
          @echo off
          setlocal

          REM WinGo - Lanzador ultra portable para USB
          cd /d %~dp0
          set "SOFTPACK_PORTABLE_ROOT=%~dp0SoftPackData"
          if not exist "%SOFTPACK_PORTABLE_ROOT%" mkdir "%SOFTPACK_PORTABLE_ROOT%"
          if not exist "%SOFTPACK_PORTABLE_ROOT%\Downloads" mkdir "%SOFTPACK_PORTABLE_ROOT%\Downloads"
          if not exist "%SOFTPACK_PORTABLE_ROOT%\Temp" mkdir "%SOFTPACK_PORTABLE_ROOT%\Temp"
          start "" "%~dp0SoftPack.exe"
          endlocal
          "@
          $bat | Out-File -FilePath "run_softpack.bat" -Encoding ascii

      - name: Crear README para USB
        working-directory: SoftPack/dist
        shell: pwsh
        run: |
          $content = @"
          WinGo - Ejecucion desde USB

          Para ejecutar: doble clic en run_softpack.bat o en SoftPack.exe
          Las descargas se guardan en SoftPackData\Downloads (dentro de la USB)
          Los temporales se limpian automaticamente al cerrar la app.

          Si el antivirus bloquea la ejecucion, permite SoftPack en tu antivirus.
          "@
          $content | Out-File -FilePath "LEEME.txt" -Encoding utf8

      - name: Subir paquete USB como artefacto
        uses: actions/upload-artifact@v4
        with:
          name: WinGo-USB-Portable
          path: |
            SoftPack/dist/SoftPack.exe
            SoftPack/dist/run_softpack.bat
            SoftPack/dist/LEEME.txt
          retention-days: 90
